#include "stdafx.h"
#include <stdio.h>
#include <fcntl.h>
#include <io.h>
#include <math.h>
#include "pattern.h"
#include "helpers.h"
#include "paint.h"
#include "MainFrm.h"
#include "Messaging.h"

extern CEmbroidermodderApp theApp;
// Procedures
class Exp : public IEmbroideryReader
{
private:

char exp_decode(unsigned char a1)
{
	unsigned char res=a1;
	if (res > 127)
		return((-~res)-1);
	else
		return (res);
}
void exp_encode(unsigned char *b,char dx,char dy,int flags)
{
	unsigned char rx=0;
	unsigned char ry=0;
	
	//if (dx < 0)
	//	rx=(~((-dx)+1));
	//else
	//	rx=res;
	//if (dy < 0)
	//	ry=(~((-res)+1));
	//else
	//	ry=res;

	if (flags==JUMP)
	{
		b[0]=128;
		b[1]=2;
		b[2]=dx;
		b[3]=dy;
	}else if (flags==STOP)
	{
		b[0]=128;
		b[1]=1;
		b[2]=dx;
		b[3]=dy;
	}else{
		b[0]=dx;
		b[1]=dy;
	}
}
public:
virtual BOOL Read(class pattern *pattern, const char *filename) {
	FILE *dstin;
	int i=0;
	unsigned char b0=0,b1=0;
	char dx=0,dy=0;
	int flags=0;
	dstin = fopen(filename,"r");

	if (dstin==0) {
		theApp.status.set("Error opening EXP file for read:",filename);
		pattern->messages.add("Error opening EXP file for read:",filename);
		return(false);
	};

	_setmode( _fileno( dstin ), _O_BINARY );
	pattern->clear();
	pattern->set_variable("file_name",filename);
	//pattern->messages.add("Begin reading stitches:");
	//READ STITCH RECORDS
	for (i=0;!feof(dstin);i++) {
		flags = NORMAL;
		b0=fgetc(dstin);
		if (feof(dstin)) break;
		b1=fgetc(dstin);
		if (feof(dstin)) break;
		if (b0 == 128)
		{
			if (b1==1)
			{
				b0=fgetc(dstin);
				if (feof(dstin)) break;
				b1=fgetc(dstin);
				if (feof(dstin)) break;
				pattern->AddColor(RGB(rand()%256,rand()%256,rand()%256),"Random","");
				flags=STOP;
			}else if ((b1==2)||(b1==4))
			{
				b0=fgetc(dstin);
				if (feof(dstin)) break;
				b1=fgetc(dstin);
				if (feof(dstin)) break;
				flags=JUMP;
			};
		};
			dx=exp_decode(b0);
			dy=exp_decode(b1);
			pattern->AddStitchRel((double)dx /10.0, (double) dy /10.0, flags);
	};
	pattern->AddStitchRel((double)dx /10.0, (double) dy /10.0, END);
	fclose(dstin);

	//pattern->print_stitchlist("cherry.txt");
	return (true);
};



virtual BOOL Write(class pattern *pattern, const char *filename) {
	FILE *expout;
	int xx=0,yy=0,dx=0,dy=0,flags=0;
	int i=0;
	unsigned char b[4];
	int inserts=0;

	if (pattern->stitches==0) {

		theApp.status.set("No file to save.");
		fprintf(stderr,"No file to save\n");
		return (false);

	};

	expout = fopen(filename,"w");
	if (expout==0) {
		theApp.status.set("Error opening EXP file for write:",filename);
		return (false);

	};
	_setmode( _fileno( expout ), _O_BINARY );
	//first pass through pattern calculating extents
	xx=yy=0;
	flags=NORMAL;
	for (i=0;flags!=END;i++){
		if (i>pattern->stitches) break;
		dx=round(pattern->stitchlist[i].xx*10.0) - xx;
		dy=round(pattern->stitchlist[i].yy*10.0) - yy;
	// insert jump point if out of range.
		if (abs(dx)>127 || abs(dy)>127) {
			double fxx,fyy,fdx,fdy;
			fxx=pattern->stitchlist[i-1].xx*10.0;
			// use doubles to do insert calculation
			fyy=pattern->stitchlist[i-1].yy*10.0;
			fdx=pattern->stitchlist[i].xx*10.0 - fxx;
			fdy=pattern->stitchlist[i].yy*10.0 - fyy;
			int splits; // number of stitches to split overlength one into
			if (abs(dx)>abs(dy)) {
				splits = round(ceil(fabs((double)dx)/127.0));
			} else {
				splits = round(ceil(fabs((double)dy)/127.0));
			};
			for (int j=1;j<splits;j++) {
				pattern->AddStitchAbs(fxx+fdx*j/splits,fyy+fdy*j/splits,JUMP);
				pattern->move_last_stitch(i+j-1);
				inserts++;
			};
		};
		xx=round(pattern->stitchlist[i].xx * 10.0); // convert from mm to 0.1mm for file format
		yy=round(pattern->stitchlist[i].yy * 10.0);
		flags=pattern->stitchlist[i].flags;
	};
	//write stitches
	xx=yy=0;
	for (i=0;i<pattern->stitches;i++) {
		dx=round(pattern->stitchlist[i].xx*10.0) - xx;
		dy=round(pattern->stitchlist[i].yy*10.0) - yy;
		xx=round(pattern->stitchlist[i].xx*10.0);
		yy=round(pattern->stitchlist[i].yy*10.0);
		flags=pattern->stitchlist[i].flags;
		exp_encode(b,dx,dy,flags);
		if ((b[0]==128) && ((b[1]==1) || (b[1]==2) || (b[1]==4)))
		{
			fprintf(expout,"%c%c%c%c",b[0],b[1],b[2],b[3]);
		}else{
			fprintf(expout,"%c%c",b[0],b[1]);
		};
	};
	fprintf(expout,"\x1a");
	// finish file with a terminator character
	//close file
	fclose(expout);
	return(true);
};
};